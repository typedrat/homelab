apiVersion: apps/v1
kind: Deployment
metadata:
    labels:
        app: rtorrent
    name: rtorrent
    namespace: media
spec:
    replicas: 1
    strategy:
        type: Recreate
    selector:
        matchLabels:
            app: rtorrent
    template:
        metadata:
            labels:
                app: rtorrent
        spec:
            securityContext:
                fsGroup: 911
            containers:
                - image: jesec/rtorrent:0.9.8-r16
                  name: rtorrent
                  securityContext:
                      runAsUser: 911
                      runAsGroup: 911
                  env:
                      - name: HOME
                        value: "/config"
                  ports:
                      - containerPort: 5000
                        name: xmlrpc
                      - containerPort: 42069
                        name: bittorrent
                      - containerPort: 6881
                        protocol: UDP
                        name: dht
                      - containerPort: 6882
                        protocol: UDP
                        name: dht-alt
                  volumeMounts:
                      - name: rtorrent-state
                        mountPath: /config
                      - name: rtorrent-rc
                        mountPath: /config/.rtorrent.rc
                        subPath: .rtorrent.rc
                      - name: media-volume
                        mountPath: /data
                - image: aauren/rtorrent-exporter:latest
                  name: rtorrent-exporter
                  command:
                      - /rtorrent-exporter
                      - -rtorrent.addr
                      - http://rtorrent:5000/RPC2
                      - -config
                      - /rtorrent-exporter.yaml
                  ports:
                      - containerPort: 9135
                        name: metrics
                  volumeMounts:
                      - name: rtorrent-exporter-config
                        mountPath: /rtorrent-exporter.yaml
                        subPath: rtorrent_exporter.yaml
            volumes:
                - name: rtorrent-state
                  persistentVolumeClaim:
                      claimName: rtorrent-state
                - name: rtorrent-rc
                  configMap:
                      name: rtorrent-rc
                - name: rtorrent-exporter-config
                  secret:
                      secretName: rtorrent-exporter-config
                  readOnly: true
                - name: media-volume
                  persistentVolumeClaim:
                      claimName: media-volume
