apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: kube-prometheus-stack
    namespace: monitoring
spec:
    interval: 5m
    chart:
        spec:
            chart: kube-prometheus-stack
            version: ">=68.4.0 <68.5"
            sourceRef:
                kind: HelmRepository
                name: prometheus-community
                namespace: monitoring
            interval: 10m
    values:
        kubeControllerManager:
            endpoints:
                - 10.0.0.10

        kubeEtcd:
            endpoints:
                - 10.0.0.10
            service:
                selector:
                    component: etcd
            serviceMonitor:
                scheme: https
                insecureSkipVerify: false
                serverName: "localhost"
                caFile: "/etc/prometheus/secrets/etcd-client-cert/etcd-ca.crt"
                certFile: "/etc/prometheus/secrets/etcd-client-cert/etcd-client.crt"
                keyFile: "/etc/prometheus/secrets/etcd-client-cert/etcd-client-key.key"
        kubeProxy:
            enabled: false

        kubeScheduler:
            endpoints:
                - 10.0.0.10

        prometheus:
            prometheusSpec:
                secrets:
                    - etcd-client-cert
